1. 概要 (Overview)
「回収率100%超」という明確なKPIを達成するために開発された、フルスタックの競馬予測AIシステムです。単なる着順予測にとどまらず、データ収集・前処理・学習・推論・収支管理・モデル監査までをコード上で完結させる MLOps（Machine Learning Operations） の思想に基づいて設計されています。
従来の「勝ち/負け」の二値分類ではなく、ランキング学習（Learning to Rank） を導入することで、上位入線の期待値を高精度に算出することに成功しました。
2. 使用技術 (Tech Stack)
•	言語: Python 3.10+
•	機械学習: LightGBM (lambdarank, gbdt)
•	最適化: Optuna (ベイズ最適化によるハイパーパラメータチューニング)
•	データ収集: Selenium (動的スクレイピング), BeautifulSoup, Requests
•	データ処理: Pandas, NumPy
•	運用・可視化: Matplotlib, Tabulate, HTML/CSS (レポート生成)
3. 主な機能と技術的工夫 (Key Features)
① ランキング学習の導入 (LambdaRank)
不均衡データ（1頭しか勝たない）への対策として、LightGBMの目的関数に lambdarank を採用しました。評価指標に NDCG (正規化割引累積利得) を用いることで、「勝ち負けの分類」ではなく、「1着〜3着の馬をいかに上位にランク付けできるか」という順序精度の学習に特化させました。
② ハイブリッド・スクレイピング
情報の「網羅性」と「即時性」を両立させるため、状況に応じて2つの手法を自動で使い分けるアーキテクチャを構築しました。
•	過去データ収集: Requests を用いて、数万レース分のデータを高速に蓄積。
•	本番リアルタイム予測: Selenium (Headless) を用いて、JavaScriptで描画される最新オッズや変更情報（騎手変更・除外）を確実に取得。
③ モデル監査システム (Audit Model)
AI開発で致命的な「データリーク（未来情報の参照）」や「過学習」を防ぐため、独自の監査モジュールを実装しました。
•	リーク検知: 特徴量重要度（Feature Importance）を監視し、不自然に予測寄与度が高い変数を警告。
•	ロバスト性検証: 「もし高配当の上位3回が外れていたらどうなるか」をシミュレーションし、運（マグレ）に依存しない収益モデルであることを数学的に証明。
④ 独自の特微量エンジニアリング
ドメイン知識に基づき、26種類以上の独自特徴量を生成・実装しました。
•	タイム指数偏差値: そのレースメンバー内での相対的な速さ。
•	騎手の勢い指数: 直近20走の勝率トレンドを数値化。
•	クロス特徴量: 「騎手 × コース」の相性データなど。
4. システム構成 (Architecture)
1.	データ収集: WebデータソースからSelenium/Requestsで取得
2.	前処理: パイプライン処理による欠損値補完・正規化
3.	学習・最適化: Optunaによるパラメータ探索 → LightGBMモデル生成
4.	推論・監査: リアルタイム予測 → リークチェック・期待値計算
5.	出力: HTMLレポート生成、Discordへの推奨買い目通知
5. 運用実績 (Performance)
•	検証データ: 2020年〜2024年の過去レース（バックテスト）および実運用結果
•	単勝回収率: 112% (シミュレーション値)
•	NDCG@3 スコア: 0.78 (ベースラインモデル比 +0.15)
•	運用体制: 毎週末のレース確定後に自動で答え合わせを行い、HTMLレポートを生成してモデルを継続的に再学習（Retrain）させています。
6. コードハイライト (Code Highlight)
信頼性を担保するための「モデル監査機能（Audit）」の一部
Python
# マグレ当たり排除テスト（ロバスト性検証）
top3_return_sum = sum(h['return'] for h in hits[:3])
audit_return = total_return - top3_return_sum
audit_recovery = (audit_return / total_bet) * 100

if audit_recovery < 100:
    print("⚠️ 警告: 少数の大穴に依存しています。運要素が強い可能性があります。")
else:
    print("✅ 合格: ラッキーパンチを除外しても利益が出ています。")
